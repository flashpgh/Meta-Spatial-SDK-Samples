name: Build SplatSample APK (runnable)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Set up Android SDK
        uses: android-actions/setup-android@v3

      - name: Install Android SDK packages
        shell: bash
        run: |
          set -euo pipefail

          sdkmanager --install \
            "platform-tools" \
            "platforms;android-34" \
            "build-tools;34.0.0"

          # Avoid failing the step on harmless SIGPIPE from `yes`
          set +o pipefail
          yes | sdkmanager --licenses > /dev/null || true
          set -o pipefail

      - name: Install Meta Spatial Editor CLI (Linux)
        shell: bash
        env:
          # OPTIONAL OVERRIDE:
          # If auto-discovery fails, set this GitHub Secret to a direct .zip/.tar.gz URL:
          # Settings -> Secrets and variables -> Actions -> New repository secret
          # Name: META_SPATIAL_EDITOR_CLI_URL
          META_SPATIAL_EDITOR_CLI_URL: ${{ secrets.META_SPATIAL_EDITOR_CLI_URL }}
        run: |
          set -euo pipefail

          CLI_PAGE="https://developers.meta.com/horizon/downloads/package/meta-spatial-editor-cli-for-linux/"
          echo "CLI page: ${CLI_PAGE}"

          URL="${META_SPATIAL_EDITOR_CLI_URL:-}"

          if [ -z "${URL}" ]; then
            echo "No META_SPATIAL_EDITOR_CLI_URL secret provided; attempting to discover direct archive link..."
            HTML="$(curl -fsSL "${CLI_PAGE}" || true)"
            if [ -n "${HTML}" ]; then
              # Try to find any direct archive link present in the HTML
              URL="$(echo "${HTML}" | grep -Eo 'https://[^"]+\.(zip|tar\.gz|tgz)' | head -n 1 || true)"
            fi
          fi

          if [ -z "${URL}" ]; then
            echo "ERROR: Could not find a direct CLI archive URL automatically."
            echo "Fix: create a GitHub Actions secret named META_SPATIAL_EDITOR_CLI_URL containing a direct download link"
            echo "to the Meta Spatial Editor CLI for Linux archive from:"
            echo "  ${CLI_PAGE}"
            exit 1
          fi

          echo "Downloading CLI archive: ${URL}"
          mkdir -p .meta_cli
          cd .meta_cli
          curl -fL "${URL}" -o cli_archive

          mkdir -p unpack
          if file cli_archive | grep -qi "zip"; then
            mv cli_archive cli.zip
            unzip -q cli.zip -d unpack
          else
            mv cli_archive cli.tgz
            tar -xf cli.tgz -C unpack
          fi

          echo "Searching for an executable in the archive..."
          BIN="$(find unpack -type f -perm -111 | head -n 1 || true)"
          if [ -z "${BIN}" ]; then
            echo "ERROR: No executable found in CLI archive."
            ech
