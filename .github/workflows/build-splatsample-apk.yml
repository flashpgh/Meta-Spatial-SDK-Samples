name: Build SplatSample APK (Fast)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # 1. Enable Gradle Caching here automatically
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"
          cache: 'gradle'

      - name: Set up Android SDK
        uses: android-actions/setup-android@v3

      # 2. Skip manual SDK install; Github Runners typically have SDK 34 pre-installed.
      # We just accept licenses to be safe.
      - name: Accept Android Licenses
        shell: bash
        run: |
          set +o pipefail
          yes | sdkmanager --licenses > /dev/null || true
          set -o pipefail

      # 3. Cache the Meta Spatial CLI download
      - name: Cache Meta Spatial CLI
        id: cache-meta-cli
        uses: actions/cache@v4
        with:
          path: .meta_cli
          # If the secret URL changes, this key changes, forcing a redownload.
          key: meta-cli-${{ runner.os }}-${{ secrets.META_SPATIAL_EDITOR_CLI_URL }}

      # 4. Only download if cache missed
      - name: Install Meta Spatial Editor CLI (If needed)
        if: steps.cache-meta-cli.outputs.cache-hit != 'true'
        shell: bash
        env:
          META_SPATIAL_EDITOR_CLI_URL: ${{ secrets.META_SPATIAL_EDITOR_CLI_URL }}
        run: |
          set -euo pipefail
          if [ -z "${META_SPATIAL_EDITOR_CLI_URL:-}" ]; then
            echo "ERROR: Missing Secret."
            exit 1
          fi

          mkdir -p .meta_cli
          cd .meta_cli
          curl -fL "${META_SPATIAL_EDITOR_CLI_URL}" -o cli_download

          mkdir -p unpack
          FT="$(file -b cli_download | tr '[:upper:]' '[:lower:]')"

          if echo "${FT}" | grep -q "zip archive"; then
            unzip -q cli_download -d unpack
          elif echo "${FT}" | grep -q "gzip compressed"; then
             tar -xzf cli_download -C unpack || (gunzip -c cli_download | tar -xf - -C unpack)
          elif echo "${FT}" | grep -q "tar archive"; then
            tar -xf cli_download -C unpack
          fi

      # 5. Always locate the binary and set the ENV var (whether cached or new)
      - name: Configure Meta CLI Path
        shell: bash
        run: |
          BIN="$(find .meta_cli/unpack -type f -perm -111 | head -n 1 || true)"
          if [ -z "${BIN}" ]; then
            echo "ERROR: CLI binary not found."
            exit 1
          fi
          BIN_ABS="$(pwd)/${BIN}"
          echo "META_SPATIAL_EDITOR_CLI_PATH=${BIN_ABS}" >> "$GITHUB_ENV"
          chmod +x "${BIN_ABS}"
          echo "CLI Ready at: ${BIN_ABS}"

      # 6. Build ONLY Debug (saves 50% time) + Parallel execution
      - name: Build Debug APK
        shell: bash
        working-directory: SplatSample
        env:
          META_SPATIAL_EDITOR_CLI_PATH: ${{ env.META_SPATIAL_EDITOR_CLI_PATH }}
        run: |
          chmod +x ./gradlew
          ./gradlew --no-daemon --parallel assembleDebug

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: SplatSample-APK
          path: SplatSample/app/build/outputs/apk/debug/*.apk
